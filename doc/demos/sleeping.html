<html>
<head>
  <title>Wat Sleeping Demo</title>
  <script type="text/javascript" src="../../wat.js"></script>
</head>
<body>
<h1><a href="https://github.com/manuel/wat-js">Wat</a></h1>
<pre id="output"></pre>

<script type="text/wat" id="sleeping">

(define default-prompt 'default-prompt)

(define *the-id* (dnew "default"))

(define (spawn-thread id)
  (push-prompt default-prompt
    (run-thread id)))

(define (cat . objects)
  (#join (list-to-array objects) ""))

(define (run-thread id)
  (loop
    (#appendChild (.body @document)
                  (#createTextNode @document (cat "Active thread: " id (dref *the-id*))))
    (sleep 250)))

(define (sleep ms)
  (take-subcont default-prompt k
    (define (callback . ignore)
      (push-prompt default-prompt
        (push-subcont k)))
    (@setTimeout (js-callback callback) ms)))

(spawn-thread 1)
(spawn-thread 2)
(spawn-thread 3)
(spawn-thread 4)
(spawn-thread 5)

</script>

<script type="text/javascript">
new wat.VM().eval(document.getElementById("sleeping").textContent);
</script>
</body>
</html>
